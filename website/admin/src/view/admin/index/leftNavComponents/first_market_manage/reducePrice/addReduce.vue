<template>
  <div class="container">
    <el-form
      ref="reduceData"
      :model="reduceData"
      :rules="reduceRules"
      label-width="130px"
      :label-position="'right'"
    >
      <el-form-item
        :label="$t('marketCommon.actName') + '：'"
        prop="name"
      >
        <el-input
          size="small"
          :placeholder="$t('marketCommon.actNamePlaceholder')"
          v-model="reduceData.name"
          class="inputWidth"
        ></el-input>
        <p style="color: #999;">{{$t('reducePriceList.actNameTip')}}</p>
      </el-form-item>
      <el-form-item
        :label="$t('marketCommon.validDate') + '：'"
        prop="effectiveDate"
      >
        <el-date-picker
          :disabled="isEditFlag"
          v-model="reduceData.effectiveDate"
          type="datetimerange"
          :range-separator="$t('marketCommon.to')"
          :start-placeholder="$t('marketCommon.startTime')"
          :end-placeholder="$t('marketCommon.endTime')"
          :default-time="['00:00:00','23:59:59']"
          value-format="yyyy-MM-dd HH:mm:ss"
          size="small"
        ></el-date-picker>
        <el-checkbox
          v-model="reduceData.isCycle"
          :disabled="isEditFlag"
        >{{$t('reducePriceList.repeatByCycle')}}</el-checkbox>
        <el-button
          size="small"
          plain
          @click="showCycleDialog"
          v-if="isEditFlag || reduceData.isCycle"
          style="margin-left: 5px;"
        >{{$t('reducePriceList.edit')}}</el-button>
      </el-form-item>
      <el-form-item
        :label="$t('reducePriceList.preTime') + '：'"
        prop="preTime"
      >
        <div>
          <span class="noticeTip">{{$t('reducePriceList.preTimeTip1')}}</span>
          <el-popover
            placement="right-start"
            width="220"
            trigger="hover"
          >
            <el-image :src="$imageHost + '/image/admin/share/advance_reduce.jpg'"></el-image>
            <el-button
              slot="reference"
              type="text"
              style="margin: 0 20 0 0px"
            >{{$t('reducePriceList.preTimeTip2')}}</el-button>
          </el-popover>
        </div>
        <div>
          <el-radio
            v-model="reduceData.preTime"
            :label="1"
            @change="preTimeChange"
            :disabled="isEditFlag"
          >{{$t('reducePriceList.preTimeTip3')}}
            <el-input
              v-model="reduceData.preTimeValue"
              :disabled="isEditFlag"
              style="width: 80px;"
              size="small"
            ></el-input>{{$t('reducePriceList.preTimeTip4')}}
          </el-radio>
          <el-radio
            v-model="reduceData.preTime"
            :label="-1"
            @change="preTimeChange"
            :disabled="isEditFlag"
          >{{$t('reducePriceList.preTimeTip5')}}</el-radio>
          <el-radio
            v-model="reduceData.preTime"
            :label="0"
            @change="preTimeChange"
            :disabled="isEditFlag"
          >{{$t('reducePriceList.preTimeTip6')}}</el-radio>
        </div>
      </el-form-item>
      <el-form-item
        :label="$t('marketCommon.first') + '：'"
        prop="first"
      >
        <el-input-number
          size="small"
          :min="0"
          :max="127"
          v-model="reduceData.first"
          class="inputWidth"
          controls-position="right"
        ></el-input-number>
      </el-form-item>
      <el-form-item
        :label="$t('reducePriceList.purchaseQuantity') + '：'"
        prop="isLimit"
      >
        <el-radio
          v-model="reduceData.isLimit"
          label="0"
          @change="limitChange"
        >{{$t('reducePriceList.noLimit')}}</el-radio>
        <br />
        <el-radio
          v-model="reduceData.isLimit"
          label="1"
          @change="limitChange"
        >{{$t('reducePriceList.limitQuantity')}}
          <el-input-number
            v-model="reduceData.limitAmount"
            controls-position="right"
            :min="0"
            size="small"
            class="small_input"
          ></el-input-number>
          {{$t('reducePriceList.piece')}}
        </el-radio>
        <div>
          <el-checkbox
            v-model="reduceData.limitFlag"
            :disabled="reduceData.isLimit === '0'"
            :true-label="1"
            :false-label="0"
          >{{$t('reducePriceList.limitQuantityTip')}}</el-checkbox>
        </div>
      </el-form-item>
      <el-form-item
        :label="$t('marketCommon.activityGoods') + '：'"
        prop="showGoodsList"
      >
        <el-button
          size="small"
          plain
          @click="showChoosingGoods"
        >
          <i class="el-icon-plus"></i> {{$t('marketCommon.selectGoods')}}
        </el-button>
        <span
          @click="onlyShowChoosingGoods"
          style="color: #e4393c"
          v-if="goodsIdList && goodsIdList.length > 0"
        >{{$t('adSharePolite.alreadyChoose')}}{{this.goodsIdList.length}}{{$t('adSharePolite.goods')}}</span>
      </el-form-item>
      <div
        v-if="pageShowGoodsList.length"
        style="padding: 0 20px;margin-bottom: 20px;"
      >
        <div class="set_item batch_item">
          <div class="item_title">
            <em>*</em> {{$t('reducePriceList.setDiscount')}}：
          </div>
          <div class="item_right">
            <el-radio-group
              v-model="batchFlag"
              @change="batchFlagChange"
            >
              <el-form-item
                style="margin-bottom: 0px;display: inline-block;margin-right: 20px;"
                label-width="0px"
                prop="batchDiscount"
              >
                <el-radio :label="1">{{$t('reducePriceList.batch')}}
                  <el-input-number
                    :disabled="batchFlag != 1 ? true : false"
                    v-model="reduceData.batchDiscount"
                    :controls="false"
                    size="small"
                    controls-position="right"
                    class="small_input"
                    :min="0"
                    :max="10"
                  ></el-input-number>{{$t('reducePriceList.discount')}}</el-radio>
              </el-form-item>
              <el-form-item
                style="margin-bottom: 0px;display: inline-block;margin-right: 20px;"
                label-width="0px"
                prop="batchReduce"
              >
                <el-radio :label="2">{{$t('reducePriceList.batch')}}{{$t('reducePriceList.priceReduction')}}
                  <el-input-number
                    :disabled="batchFlag != 2 ? true : false"
                    v-model="reduceData.batchReduce"
                    :controls="false"
                    size="small"
                    controls-position="right"
                    class="small_input"
                    :min="0"
                  ></el-input-number>{{$t('marketCommon.yuan')}}</el-radio>
              </el-form-item>
              <el-form-item
                style="margin-bottom: 0px;display: inline-block;margin-right: 20px;"
                label-width="0px"
                prop="batchFinalPrice"
              >
                <el-radio :label="3">{{$t('reducePriceList.batch')}}{{$t('reducePriceList.priceAfterDiscount')}}
                  <el-input-number
                    :disabled="batchFlag != 3 ? true : false"
                    v-model="reduceData.batchFinalPrice"
                    :controls="false"
                    size="small"
                    controls-position="right"
                    class="small_input"
                    :min="0"
                  ></el-input-number>{{$t('marketCommon.yuan')}}</el-radio>
              </el-form-item>
            </el-radio-group>
            <el-button
              type="primary"
              size="small"
              @click="batchSet"
            >{{$t('marketCommon.ok')}}</el-button>
            <el-button
              type="default"
              size="small"
              @click="resetPrice"
            >{{$t('marketCommon.cancel')}}</el-button>
          </div>
        </div>
        <el-table
          :data="pageShowGoodsList"
          border
          :header-cell-style="{
            'background-color':'#f5f5f5',
            'text-align':'center',
            'border':'none'
          }"
          :cell-style="{
            'text-align':'center'
          }"
          ref="multipleTable"
        >
          <el-table-column
            type="selection"
            width="55"
          >
          </el-table-column>
          <template v-for="item in tableLabel">
            <el-table-column
              :prop="item.prop"
              :label="item.label"
              :key="item.index"
              v-if="item.index === 1"
            >
              <template slot-scope="scope">
                <div class="goods_info">
                  <img
                    :src="scope.row.goodsImg"
                    alt=""
                    class="goods_img"
                  >
                  <div class="goods_name">
                    {{scope.row.goodsName}}
                  </div>
                </div>
              </template>
            </el-table-column>
            <el-table-column
              :prop="item.prop"
              :label="item.label"
              :key="item.index"
              v-else-if="item.index === 4"
              width="150"
            >
              <template slot-scope="scope">
                <el-input-number
                  v-model="scope.row.discount"
                  :controls="false"
                  size="small"
                  controls-position="right"
                  class="small_input"
                  @change="changeItemDiscount(scope.row)"
                ></el-input-number> {{$t('reducePriceList.discount')}}
              </template>
            </el-table-column>
            <el-table-column
              :prop="item.prop"
              :label="item.label"
              :key="item.index"
              v-else-if="item.index === 5"
              width="150"
            >
              <template slot-scope="scope">
                <el-input-number
                  v-model="scope.row.reducePrice"
                  :controls="false"
                  size="small"
                  controls-position="right"
                  class="small_input"
                  @change="changeItemReducePrice(scope.row)"
                ></el-input-number> {{$t('marketCommon.yuan')}}
              </template>
            </el-table-column>
            <el-table-column
              :prop="item.prop"
              :label="item.label"
              :key="item.index"
              v-else-if="item.index === 6"
              width="150"
            >
              <template slot-scope="scope">
                <p class="price_red">{{reduceError(scope.row)}}</p>
                <el-input-number
                  v-model="scope.row.goodsPrice"
                  :controls="false"
                  size="small"
                  controls-position="right"
                  class="small_input"
                  @change="changeItemGoodsPrice(scope.row)"
                ></el-input-number> {{$t('marketCommon.yuan')}}
                <p
                  class="price_blue"
                  @click="getProductInfo(scope.row)"
                  v-if="scope.row.reducePriceProduct && scope.row.reducePriceProduct.length>0"
                >{{scope.row.reducePriceProduct.length}}{{$t('reducePriceList.productReducePriceTip')}}</p>
                <!-- @click="isEditFlag ? clickHandler() : getProductInfo(scope.row)" -->
              </template>
            </el-table-column>
            <el-table-column
              :prop="item.prop"
              :label="item.label"
              :key="item.index"
              width="80"
              v-else-if="item.index === 7"
            >
              <template slot-scope="scope">
                <span
                  class="del_item"
                  @click="isGoing ? clickHandler() : delReduceData(scope.row.goodsId)"
                >{{$t('marketCommon.delete')}}</span>
              </template>
            </el-table-column>
            <el-table-column
              :prop="item.prop"
              :label="item.label"
              :key="item.index"
              v-else
            ></el-table-column>
          </template>
        </el-table>
      </div>
      <el-form-item
        :label="$t('reducePriceList.activityTag') + '：'"
        prop=""
      >
        <el-checkbox
          v-model="reduceData.activityTag"
          :true-label="1"
          :false-label="0"
          :disabled="isEditFlag"
        >{{$t('reducePriceList.activityTagTip1')}}</el-checkbox>
        <el-tooltip
          :content="$t('reducePriceList.activityTagTip2')"
          placement="top"
          effect="light"
        >
          <span
            class="el-icon-question"
            style="color: #666;cursor: pointer;"
          ></span>
        </el-tooltip>
        <span
          class="labelStyle"
          @click="selectLabel"
        >{{$t('reducePriceList.activityTagTip3')}}</span>
        <div v-if="pickLabel.length > 0">
          <p style="color: #999;">{{$t('reducePriceList.activityTagTip4')}}</p>
          <div
            v-for="(item, index) in pickLabel"
            :key="index"
            class="labelContent"
          >
            {{item.value}}
            <i
              class="el-icon-close"
              @click="deleteLabel(index)"
              style="color: #999; margin-left: 3px;cursorL pointer;"
            ></i>
          </div>
        </div>

      </el-form-item>

      <!-- 收起、展开更多配置 -->
      <div
        @click="handleToChangeArror"
        style="padding: 0 0 30px 30px; width: 20%;"
      >
        <div
          v-if="arrorFlag"
          style="color:rgb(90, 139, 255);cursor:pointer"
        >
          {{ $t('seckill.openConfigure') }}&nbsp;<img :src="ArrowArr[0].img_1">
        </div>
        <div
          v-if="!arrorFlag"
          style="color:rgb(90, 139, 255);cursor:pointer"
        >
          {{ $t('seckill.closeConfigure') }}&nbsp;<img :src="ArrowArr[1].img_2">
        </div>
      </div>

      <div v-if="!arrorFlag">
        <!-- 活动分享 -->
        <el-form-item
          prop="shareConfig.shareAction"
          label="活动分享："
        >
          <div class="shareContent">
            <el-radio
              v-model="reduceData.shareConfig.shareAction"
              :label="1"
            >默认样式</el-radio>
            <el-popover
              placement="right-start"
              width="220"
              trigger="hover"
            >
              <el-image :src="srcList.src1"></el-image>
              <el-button
                slot="reference"
                type="text"
                style="margin: 0 20 0 0px"
              >查看示例</el-button>
            </el-popover>
            <el-popover
              placement="right-start"
              width="220"
              trigger="hover"
            >
              <el-image :src="srcList.src2"></el-image>
              <el-button
                slot="reference"
                type="text"
              >下载海报</el-button>
            </el-popover>
          </div>
          <div>
            <el-radio
              v-model="reduceData.shareConfig.shareAction"
              :label="2"
            >自定义样式</el-radio>
            <div v-if="reduceData.shareConfig.shareAction === 2">
              <span>文案：</span>
              <el-input
                v-model="reduceData.shareConfig.shareDoc"
                size="small "
                style="width: 170px;"
              ></el-input>
            </div>
            <div v-if="reduceData.shareConfig.shareAction === 2">
              <span>分享图：</span>
              <el-radio
                v-model="reduceData.shareConfig.shareImgAction"
                :label="1"
              >活动商品信息图</el-radio>
              <div style="margin-left: 60px;">
                <el-radio
                  v-model="reduceData.shareConfig.shareImgAction"
                  :label="2"
                >自定义图片</el-radio>
              </div>

              <div
                style="display: flex"
                v-if="reduceData.shareConfig.shareImgAction === 2"
                :disabled="isEditFlag"
              >
                <div
                  class="imgContent"
                  @click="addGoodsImg"
                >
                  <div style="width: 100%; height: 100%;">
                    <img
                      v-if="reduceData.shareConfig.shareImg === ''"
                      :src="$imageHost + '/image/admin/shop_beautify/add_decorete.png'"
                      alt=""
                    >
                    <img
                      v-if="reduceData.shareConfig.shareImg !== ''"
                      :src="reduceData.shareConfig.shareImg"
                      alt=""
                      class="shareImg"
                    >
                  </div>
                </div>
                <span class="picSizeTips">建议尺寸：800*800像素</span>
              </div>
            </div>
          </div>
        </el-form-item>
      </div>

    </el-form>

    <div class="footer">
      <el-button
        @click="saveClickHandler"
        type="primary"
        size="small"
      >{{$t('marketCommon.save')}}</el-button>
    </div>

    <!--图片弹窗-->
    <ImageDalog
      pageIndex='userCardAdd'
      :tuneUp="tuneUp"
      @handleSelectImg='handleSelectImg'
    />

    <!-- 重复周期弹窗 -->
    <CycleDialog
      :cycleDialog="cycleDialogShow"
      :CycleType="periodAction"
      :CycleDate="extendTime"
      :CycleData="CycleData"
      :isEdit="isEditFlag"
      @handelCycleData="getCycleData"
    />

    <!-- 选择商品 -->
    <choosingGoods
      :tuneUpChooseGoods="tuneUpChooseGoods"
      :chooseGoodsBack="goodsIdList"
      :onlyShowChooseGoods="isOnlyShowChooseGoods"
      @resultGoodsIds="getGoodsIds"
    />

    <!-- 规格信息弹框 -->
    <productInfo
      :productDialog.sync="productDialogFlag"
      :product-info="productInfo"
      :isEdit="isEditFlag"
      @confrim="getProductdata"
    />

    <!-- 标签弹窗 -->
    <LabelDialog
      :dialogVisible="labelDialogVisible"
      :multipleLimit="3"
      @resultLabelDatas="resultLabelDatas"
      :chooseLabelBack="reduceData.activityTagId"
    />

  </div>
</template>

<script>
import { addReducePrice, getReducePriceById, updateReducePrice } from '@/api/admin/marketManage/reducePrice.js'
import { getGoodsInfosByGoodIds } from '@/api/admin/goodsManage/allGoods/allGoods'
import { allTagApi } from '@/api/admin/marketManage/messagePush'
export default {
  components: {
    ImageDalog: () => import('@/components/admin/imageDalog'),
    CycleDialog: () => import('./repeatCycle'),
    choosingGoods: () => import('@/components/admin/choosingGoods'),
    productInfo: () => import('./productInfo'),
    actShare: () => import('@/components/admin/marketManage/marketActivityShareSetting'),
    LabelDialog: () => import('@/components/admin/labelDialog')
  },
  props: ['isEdite', 'editId', 'isGoing'],
  data () {
    // 自定义限购
    var validateLimit = (rule, value, callback) => {
      if (value === '1' && this.reduceData.limitAmount === undefined) {
        callback(new Error('请填写限购数量'))
      } else if (value === '1' && this.reduceData.limitAmount === 0) {
        callback(new Error('限购数量必须大于0'))
      } else {
        callback()
      }
    }
    // 自定义活动商品
    var validateGoods = (rule, value, callback) => {
      console.log(this.pageShowGoodsList)
      if (!this.pageShowGoodsList || this.pageShowGoodsList.length === 0) {
        callback(new Error('请选择活动商品'))
      } else {
        callback()
      }
    }
    // 自定义活动预告
    var validatePreTime = (rule, value, callback) => {
      var re = /^[1-9]\d*$/
      if (value !== -1 && value !== 0 && value !== 1) {
        callback(new Error('请选择活动预告类型'))
      } else if (value === 1 && this.reduceData.preTimeValue === '') {
        callback(new Error('请填写活动预告时间'))
      } else if (value === 1 && !re.test(this.reduceData.preTimeValue)) {
        callback(new Error('活动预告时间填写不正确'))
      } else {
        callback()
      }
    }
    // 自定义校验折扣
    var validateDiscount = (rule, value, callback) => {
      if (this.batchFlag === 1) {
        if (!value && value !== 0) {
          callback(new Error('请填写批量折扣'))
        } else {
          callback()
        }
      } else {
        callback()
      }
    }
    // 自定义校验减价
    var validateReduce = (rule, value, callback) => {
      if (this.batchFlag === 2) {
        if (!value && value !== 0) {
          callback(new Error('请填写批量减价'))
        } else {
          callback()
        }
      } else {
        callback()
      }
    }
    // 自定义校验折后价
    var validateFinalPrice = (rule, value, callback) => {
      if (this.batchFlag === 3) {
        if (!value && value !== 0) {
          callback(new Error('请填写批量折扣价'))
        } else {
          callback()
        }
      } else {
        callback()
      }
    }
    return {
      // 展开设置箭头
      ArrowArr: [{
        img_1: this.$imageHost + '/image/admin/show_more.png'
      }, {
        img_2: this.$imageHost + '/image/admin/hid_some.png'
      }],
      // 展开更多配置
      arrorFlag: true,
      srcList: {
        src1: `${this.$imageHost}/image/admin/share/reduce_share.jpg`,
        src2: `${this.$imageHost}/image/admin/share/reduce_pictorial.jpg`
      },

      isEditFlag: this.isEdite, // 编辑时部分信息不可修改
      batchFlag: null,
      // 周期弹窗
      cycleDialogShow: false,
      periodAction: null,
      extendTime: '',
      CycleData: '',

      reduceData: {
        name: '',
        effectiveDate: '',
        preTime: 1, // 活动预告
        preTimeValue: '24', // 预告时间值
        first: 1, // 优先级
        isCycle: false,
        isLimit: '0',
        limitFlag: 0,
        limitAmount: 1,
        batchDiscount: '', // 设置折扣
        batchReduce: '',
        batchFinalPrice: '',
        activityTag: 0, // 同步打标签
        activityTagId: [], // 标签id值
        shareConfig: {
          shareAction: 1,
          shareDoc: '',
          shareImgAction: 1,
          shareImg: ''
        }
      },
      // 表单校验
      reduceRules: {
        name: [
          { required: true, message: '请填写活动名称', trigger: 'blur' }
        ],
        effectiveDate: [
          { required: true, message: '请填写有效期', trigger: 'change' }
        ],
        preTime: [
          { required: true, validator: validatePreTime, trigger: 'change' }
        ],
        first: [
          { required: true, message: '请填写优先级', trigger: 'blur' }
        ],
        isLimit: [
          { required: true, validator: validateLimit, trigger: 'change' }
        ],
        showGoodsList: [
          { required: true, validator: validateGoods, trigger: 'change' }
        ],
        batchDiscount: [
          { required: true, validator: validateDiscount, trigger: 'change' }
        ],
        batchReduce: [
          { required: true, validator: validateReduce, trigger: 'change' }
        ],
        batchFinalPrice: [
          { required: true, validator: validateFinalPrice, trigger: 'change' }
        ]
      },

      changeFlag: false,
      productDialogFlag: false,
      productInfo: {},
      pageShowGoodsList: [],
      tableLabel: [
        { index: 1, prop: 'goodsName', label: this.$t('marketCommon.goodsName') },
        { index: 2, prop: 'shopPrice', label: this.$t('reducePriceList.originalPrice') },
        { index: 3, prop: 'goodsNumber', label: this.$t('reducePriceList.stock') },
        { index: 4, prop: 'discount', label: this.$t('reducePriceList.discount') },
        { index: 5, prop: 'reducePrice', label: this.$t('reducePriceList.priceReduction') },
        { index: 6, prop: 'goodsPrice', label: this.$t('reducePriceList.priceAfterDiscount') },
        { index: 7, prop: '', label: this.$t('marketCommon.operate') }
      ],
      goodsIdList: [],
      tuneUp: false,
      tuneUpChooseGoods: false,
      isOnlyShowChooseGoods: false,

      labelDialogVisible: false, // 标签弹窗
      labelList: [], // 标签列表数据
      pickLabel: [] // 选中标签列表
    }
  },
  watch: {
    // 国际化
    lang () {
      this.tableLabel = [
        { index: 1, prop: 'goodsName', label: this.$t('marketCommon.goodsName') },
        { index: 2, prop: 'shopPrice', label: this.$t('reducePriceList.originalPrice') },
        { index: 3, prop: 'goodsNumber', label: this.$t('reducePriceList.stock') },
        { index: 4, prop: 'discount', label: this.$t('reducePriceList.discount') },
        { index: 5, prop: 'reducePrice', label: this.$t('reducePriceList.priceReduction') },
        { index: 6, prop: 'goodsPrice', label: this.$t('reducePriceList.priceAfterDiscount') },
        { index: 7, prop: '', label: this.$t('marketCommon.operate') }
      ]
    }
  },
  mounted () {
    this.langDefault()
    this.getTagList()

    this.changeFlag = true

    // 编辑初始化
    if (this.isGoing === true) {
      this.editReduceInit()
    }
  },
  methods: {
    // 获取标签列表
    getTagList () {
      allTagApi().then(res => {
        if (res.error === 0) {
          this.labelList = res.content
        }
      })
    },

    // 展开更多配置
    handleToChangeArror () {
      this.arrorFlag = !this.arrorFlag
    },

    // 图片弹窗
    addGoodsImg () {
      this.tuneUp = !this.tuneUp
    },

    // 图片选中
    handleSelectImg (res) {
      this.reduceData.shareConfig.shareImg = res.imgUrl
    },

    // 周期弹窗
    showCycleDialog (val) {
      if (this.changeFlag) {
        this.cycleDialogShow = val
      }
    },

    // 周期回显数据
    getCycleData (arr) {
      // 按周期重复
      Object.assign(this.reduceData, arr)
    },

    // 商品弹窗
    showChoosingGoods () {
      this.isOnlyShowChooseGoods = false
      this.tuneUpChooseGoods = !this.tuneUpChooseGoods
    },
    // 商品弹窗部分
    onlyShowChoosingGoods () {
      this.isOnlyShowChooseGoods = true
      this.tuneUpChooseGoods = !this.tuneUpChooseGoods
    },

    // 选择商品
    getGoodsIds (data) {
      this.goodsIdList = data
      var param = {
        goodsIds: this.goodsIdList
      }
      getGoodsInfosByGoodIds(param).then(res => {
        if (res.error === 0) {
          res.content.forEach(item => {
            item.reducePriceProduct = item.goodsSpecProducts
            item.discount = 10
            item.reducePrice = 0
            item.goodsPrice = item.shopPrice
            if (item.reducePriceProduct != null && item.reducePriceProduct.length > 0) {
              item.reducePriceProduct.forEach(spec => {
                spec.originalPrice = spec.prdPrice

                spec.prdPrice = item.goodsPrice
              })
            }
          })
          this.pageShowGoodsList = res.content
          console.log(this.pageShowGoodsList)

          this.$refs.reduceData.validateField('showGoodsList')
        }
      })
    },
    delReduceData (id) {
      let index = this.goodsIdList.findIndex(item => {
        return item === id
      })
      this.goodsIdList.splice(index, 1)
      let goodsTarget = this.pageShowGoodsList.findIndex(item => {
        return id === item.goodsId
      })
      this.pageShowGoodsList.splice(goodsTarget, 1)
      this.$refs.reduceData.validateField('showGoodsList')
    },
    getProductInfo (data) {
      this.productDialogFlag = true
      this.productInfo = data
      console.log(this.productInfo)
    },
    // 规格价格弹窗回调
    getProductdata (goodsId, ProductInfo) {
      let goodsTarget = this.pageShowGoodsList.findIndex(item => {
        return goodsId === item.goodsId
      })
      this.pageShowGoodsList[goodsTarget].reducePriceProduct = ProductInfo
      this.pageShowGoodsList[goodsTarget].goodsSpecProducts = ProductInfo
    },
    batchSet () {
      console.log(this.$refs.multipleTable.selection)
      if (this.$refs.multipleTable.selection.length === 0) {
        this.$message.warning(this.$t('reducePriceList.batchValidSet'))
        return false
      } else {
        switch (this.batchFlag) {
          case 1:
            if (!this.reduceData.batchDiscount) {
              this.$message.warning(this.$t('reducePriceList.batchValidDiscount1'))
              return false
            } else if (parseFloat(this.reduceData.batchDiscount) <= 0 || parseFloat(this.reduceData.batchDiscount) >= 10) {
              this.$message.warning(this.$t('reducePriceList.batchValidDiscount2'))
              return false
            }
            this.$refs.multipleTable.selection.map(item => {
              let shopPrice = parseFloat(item.shopPrice)
              let goodsPriceFloat = (shopPrice * parseFloat(this.reduceData.batchDiscount / 10)).toFixed(3)
              let reducePriceFloat = parseFloat(shopPrice - goodsPriceFloat).toFixed(3)
              item.goodsPrice = parseFloat(goodsPriceFloat.substring(0, goodsPriceFloat.length - 1))
              item.reducePrice = parseFloat(reducePriceFloat.substring(0, reducePriceFloat.length - 1))
              item.discount = this.reduceData.batchDiscount
              if (item.reducePriceProduct && item.reducePriceProduct.length) {
                item.reducePriceProduct.map(item2 => {
                  let originalPrice = item2.originalPrice
                  let prdPriceFloat = (originalPrice * (parseFloat(this.reduceData.batchDiscount / 10))).toFixed(2)
                  item2.prdPrice = parseFloat(prdPriceFloat.substring(0, prdPriceFloat.length - 1))
                })
              }
            })
            break
          case 2:
            this.$refs.multipleTable.selection.map(item => {
              let shopPrice = parseFloat(item.shopPrice)
              let goodsPriceFloat = parseFloat(shopPrice - this.reduceData.batchReduce).toFixed(3)
              let discountFloat = (parseFloat(goodsPriceFloat / shopPrice) * 10).toFixed(3)
              item.goodsPrice = parseFloat(goodsPriceFloat.substring(0, goodsPriceFloat.length - 1))
              this.$nextTick(() => {
                item.reducePrice = this.reduceData.batchReduce
                item.discount = parseFloat(discountFloat.substring(0, discountFloat.length - 1))
                if (item.reducePriceProduct && item.reducePriceProduct.length) {
                  item.reducePriceProduct.map(item2 => {
                    let originalPrice = item2.originalPrice
                    let prdPriceFloat = parseFloat(originalPrice - this.reduceData.batchReduce).toFixed(3)
                    item2.prdPrice = parseFloat(prdPriceFloat.substring(0, prdPriceFloat.length - 1))
                  })
                }
              })
            })
            break
          case 3:
            this.$refs.multipleTable.selection.map(item => {
              let shopPrice = parseFloat(item.shopPrice)
              let reducePriceFloat = parseFloat(shopPrice - this.reduceData.batchFinalPrice).toFixed(3)
              let discountFloat = (parseFloat(this.reduceData.batchFinalPrice / shopPrice) * 10).toFixed(3)
              item.goodsPrice = this.reduceData.batchFinalPrice
              this.$nextTick(() => {
                item.reducePrice = parseFloat(reducePriceFloat.substring(0, reducePriceFloat.length - 1))
                item.discount = parseFloat(discountFloat.substring(0, discountFloat.length - 1))
                if (item.reducePriceProduct && item.reducePriceProduct.length) {
                  item.reducePriceProduct.map(item2 => {
                    item2.prdPrice = this.reduceData.batchFinalPrice
                  })
                }
              })
            })
            break
          default:
            this.$message.warning(this.$t('reducePriceList.batchValidSetType'))
            break
        }
      }
    },
    resetPrice () {
      this.pageShowGoodsList.map(item => {
        item.goodsPrice = ''
        item.reducePrice = ''
        item.discount = ''
        if (item.reducePriceProduct && item.reducePriceProduct.length) {
          item.reducePriceProduct.map(item2 => {
            item2.originalPrice = ''
          })
        }
      })
    },
    changeItemDiscount (rowData) {
      let goodsTarget = this.pageShowGoodsList.findIndex(item => {
        return rowData.goodsId === item.goodsId
      })
      let itemData = this.pageShowGoodsList[goodsTarget]
      if (rowData.discount === undefined) {
        itemData.goodsPrice = undefined
        itemData.reducePrice = undefined
      } else {
        let shopPrice = parseFloat(itemData.shopPrice)
        let goodsPriceFloat = (shopPrice * parseFloat(rowData.discount / 10)).toFixed(3)
        let reducePriceFloat = parseFloat(shopPrice - goodsPriceFloat).toFixed(3)
        itemData.goodsPrice = parseFloat(goodsPriceFloat.substring(0, goodsPriceFloat.length - 1))
        itemData.reducePrice = parseFloat(reducePriceFloat.substring(0, reducePriceFloat.length - 1))
        if (this.isEditFlag === false && itemData.reducePriceProduct && itemData.reducePriceProduct.length) {
          itemData.reducePriceProduct.map(item => {
            // let originalPrice = item.originalPrice
            // let prdPriceFloat = (originalPrice * (parseFloat(rowData.discount / 10))).toFixed(3)
            // item.prdPrice = parseFloat(prdPriceFloat.substring(0, prdPriceFloat.length - 1))
            item.prdPrice = rowData.goodsPrice
          })
        }
      }
    },
    changeItemReducePrice (rowData) {
      let goodsTarget = this.pageShowGoodsList.findIndex(item => {
        return rowData.goodsId === item.goodsId
      })
      let itemData = this.pageShowGoodsList[goodsTarget]
      if (rowData.reducePrice === undefined) {
        itemData.goodsPrice = undefined
        itemData.discount = undefined
      } else {
        let shopPrice = parseFloat(itemData.shopPrice)
        let goodsPriceFloat = parseFloat(shopPrice - rowData.reducePrice).toFixed(3)
        let discountFloat = (parseFloat(goodsPriceFloat / shopPrice) * 10).toFixed(3)
        itemData.goodsPrice = parseFloat(goodsPriceFloat.substring(0, goodsPriceFloat.length - 1))
        itemData.discount = parseFloat(discountFloat.substring(0, discountFloat.length - 1))
        if (this.isEditFlag === false && itemData.reducePriceProduct && itemData.reducePriceProduct.length) {
          itemData.reducePriceProduct.map(item => {
            // let originalPrice = item.originalPrice
            // let prdPriceFloat = parseFloat(originalPrice - rowData.reducePrice).toFixed(3)
            // item.prdPrice = parseFloat(prdPriceFloat.substring(0, prdPriceFloat.length - 1))
            item.prdPrice = rowData.goodsPrice
          })
        }
      }
    },
    changeItemGoodsPrice (rowData) {
      let goodsTarget = this.pageShowGoodsList.findIndex(item => {
        return rowData.goodsId === item.goodsId
      })
      let itemData = this.pageShowGoodsList[goodsTarget]
      if (rowData.goodsPrice === undefined) {
        itemData.reducePrice = undefined
        itemData.discount = undefined
      } else {
        let shopPrice = parseFloat(itemData.shopPrice)
        let reducePriceFloat = parseFloat(shopPrice - rowData.goodsPrice).toFixed(3)
        let discountFloat = (parseFloat(rowData.goodsPrice / shopPrice) * 10).toFixed(3)
        itemData.reducePrice = parseFloat(reducePriceFloat.substring(0, reducePriceFloat.length - 1))
        itemData.discount = parseFloat(discountFloat.substring(0, discountFloat.length - 1))
        if (this.isEditFlag === false && itemData.reducePriceProduct && itemData.reducePriceProduct.length) {
          itemData.reducePriceProduct.map(item => {
            item.prdPrice = rowData.goodsPrice
          })
        }
      }
    },
    reduceError (rowData) {
      if (rowData.discount || rowData.reducePrice || rowData.goodsPrice) {
        if (rowData.goodsPrice > rowData.shopPrice) {
          return this.$t('reducePriceList.batchValidPrice1')
        } else if (rowData.goodsPrice < 0) {
          return this.$t('reducePriceList.batchValidPrice2')
        } else if (rowData.shopPrice > 0 && rowData.shopPrice < 0.01) {
          return this.$t('reducePriceList.batchValidPrice2')
        } else {
          return ''
        }
      }
    },

    // 编辑回显
    editReduceInit () {
      // 展开更多配置
      this.arrorFlag = false
      // 编辑时部分信息不可修改
      // this.isEditFlag = true
      getReducePriceById({ id: this.editId }).then((res) => {
        if (res.error === 0) {
          this.reduceData = res.content
          // 有效期
          this.reduceData.effectiveDate = [res.content.startTime, res.content.endTime]
          // 周期
          if (this.reduceData.periodAction === 1 || this.reduceData.periodAction === 2 || this.reduceData.periodAction === 3) {
            this.reduceData.isCycle = true
          }
          // 周期弹窗数据回显
          this.periodAction = this.reduceData.periodAction
          this.extendTime = this.reduceData.extendTime
          this.CycleData = this.reduceData.pointTime
          // 限购数量
          if (this.reduceData.limitAmount !== null && this.reduceData.limitAmount > 0) {
            this.$set(this.reduceData, 'isLimit', '1')
          } else {
            this.reduceData.limitAmount = 1
            this.$set(this.reduceData, 'isLimit', '0')
          }

          // 活动分享
          this.reduceData.shareConfig = res.content.shopShareConfig

          // 活动商品
          res.content.reducePriceGoods.map(item => {
            item.goodsName = item.goodsView.goodsName
            item.goodsNumber = item.goodsView.goodsNumber
            item.goodsImg = item.goodsView.goodsImg
            item.shopPrice = item.goodsView.shopPrice
          })
          this.pageShowGoodsList = res.content.reducePriceGoods

          // 商品弹窗回显
          this.goodsIdList = []
          this.pageShowGoodsList.forEach(item => {
            this.goodsIdList.push(item.goodsId)
          })

          // 活动预告
          if (this.reduceData.preTime > 0) {
            this.reduceData.preTimeValue = this.reduceData.preTime
            this.reduceData.preTime = 1
          }

          // 标签id
          if (res.content.tagList && res.content.tagList.length > 0) {
            this.pickLabel = res.content.tagList
            this.reduceData.activityTagId = []
            res.content.tagList.forEach(item => {
              this.reduceData.activityTagId.push(item.id)
            })
          } else {
            this.reduceData.activityTagId = []
          }
        } else {
          this.$message.warning(res.message)
        }
      })
    },

    // 保存限时降价
    saveClickHandler () {
      var result = this.pageShowGoodsList.findIndex(item => { return item.discount === undefined || item.reducePrice === undefined || item.goodsPrice === undefined })
      if (result === -1) {
        var errorTip = this.pageShowGoodsList.map(item => { return this.reduceError(item) })
        if (errorTip.findIndex(item => { return item !== '' }) !== -1) {
          return false
        }
      } else {
        this.$message.warning('请完整填写活动商品价格!')
        return false
      }
      this.$refs['reduceData'].validate((valid) => {
        if (valid) {
          // 有效期
          this.reduceData.startTime = this.reduceData.effectiveDate[0]
          this.reduceData.endTime = this.reduceData.effectiveDate[1]
          // 限购数量
          if (this.reduceData.isLimit === '0') {
            this.reduceData.limitAmount = 0
          }
          // 改价的商品数组
          this.reduceData.reducePriceGoodsAddParams = this.pageShowGoodsList
          // 周期类型
          if (!this.reduceData.isCycle) {
            this.reduceData.periodAction = 0
          }
          // 活动预告
          if (this.reduceData.preTime === 1) {
            this.reduceData.preTime = Number(this.reduceData.preTimeValue)
          }
          // 同步打标签
          // if (this.reduceData.activityTagId && this.reduceData.activityTagId.length > 0) {
          //   this.reduceData.activityTagId = this.reduceData.activityTagId.toString()
          // }

          console.log(this.reduceData)
          if (this.isGoing === false) {
            // 添加限时降价
            addReducePrice(this.reduceData).then((res) => {
              if (res.error === 0) {
                this.$message.success({ message: '添加成功' })
                this.$emit('addReduceSubmit')
              } else {
                this.$message.warning({ message: '添加失败' })
              }
            })
          } else {
            // 编辑限时降价
            updateReducePrice(this.reduceData).then((res) => {
              if (res.error === 0) {
                this.$message.success({ message: '编辑成功' })
                this.$emit('addReduceSubmit')
              } else {
                this.$message.warning({ message: '编辑失败' })
              }
            })
          }
        }
      })
    },

    // 标签弹窗
    selectLabel () {
      if (this.isEditFlag === true) {
        return false
      }
      this.labelDialogVisible = !this.labelDialogVisible
    },

    // 删除标签
    deleteLabel (index) {
      if (this.isEditFlag === true) {
        this.$message.warning('编辑状态不可操作')
        return false
      }
      this.pickLabel.splice(index, 1)
      this.reduceData.activityTagId = []
      this.pickLabel.forEach(item => {
        this.reduceData.activityTagId.push(item.id)
      })
    },

    // 标签弹窗回调函数
    resultLabelDatas (row) {
      this.pickLabel = row
      this.reduceData.activityTagId = []
      this.pickLabel.forEach(item => {
        this.reduceData.activityTagId.push(item.id)
      })
    },

    // 活动预告类型切换
    preTimeChange (e) {
      this.$refs['reduceData'].validateField('preTime')
    },

    // 批量设置切换
    batchFlagChange () {
      this.$refs.reduceData.validateField('batchDiscount')
      this.$refs.reduceData.validateField('batchReduce')
      this.$refs.reduceData.validateField('batchFinalPrice')
    },

    clickHandler () { },

    // 限购切换
    limitChange (val) {
      if (val === '0') {
        this.reduceData.limitFlag = 0
      }
      this.$refs.reduceData.validateField('isLimit')
    }

    // 提交前校验
    // validParam() {
    //   if (!this.reduceData.name) {
    //     this.$message.warning(this.$t('reducePriceList.validActName'))
    //     return false
    //   }
    //   if (!this.reduceData.startTime || !this.reduceData.endTime) {
    //     this.$message.warning(this.$t('reducePriceList.validActDate'))
    //     return false
    //   }
    //   if (!this.reduceData.reducePriceGoodsAddParams || this.reduceData.reducePriceGoodsAddParams.length === 0) {
    //     this.$message.warning(this.$t('reducePriceList.validActGoods'))
    //     return false
    //   }
    //   let flag = false
    //   this.reduceData.reducePriceGoodsAddParams.forEach(item => {
    //     if (!item.discount || !item.reducePrice || !item.goodsPrice) {
    //       flag = true
    //     } else {
    //       if (item.reducePriceProduct) {
    //         item.reducePriceProduct.forEach(prdItem => {
    //           if (!prdItem.prdPrice) {
    //             flag = true
    //           }
    //         })
    //       }
    //     }
    //   })
    //   if (flag) {
    //     this.$message.warning(this.$t('reducePriceList.validActGoodsPrice'))
    //     return false
    //   }
    //   return true
    // }
  }
}
</script>

<style lang="scss" scoped>
.container {
  padding-top: 10px;
  background: #fff;
  margin-bottom: 10px;
  .main {
    padding: 10px;
    background-color: #fff;
    .set_box {
      padding: 0 12px 0;
      border-radius: 3px;
      /deep/ .el-collapse {
        border: none;
        .el-collapse-item__wrap {
          border-bottom: none;
        }
        .el-collapse-item__header {
          border-bottom: none;
          color: #409eff;
          width: 105px;
        }
        .el-collapse-item__content {
          padding-bottom: 0;
        }
      }
    }
  }
  .small_input {
    width: 90px;
  }
  .default_input {
    width: 150px;
  }
  .goods_info {
    display: flex;
    > img {
      width: 45px;
      height: 45px;
      margin-right: 5px;
    }
    > .goods_name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      overflow: hidden;
      /*! autoprefixer: off */
      -webkit-box-orient: vertical;
      text-align: left;
    }
  }
  .price_blue {
    color: #5a8bff;
    padding-top: 2px;
    cursor: pointer;
  }
  .price_red {
    color: red;
    padding-bottom: 2px;
    cursor: pointer;
    font-size: 12px;
  }
  .del_item {
    color: #66b1ff;
    cursor: pointer;
  }
}
.inputWidth {
  width: 170px;
}
.footer {
  width: 100%;
  height: 50px;
  padding: 10px 0;
  background: #f8f8f8;
  text-align: center;
}
.set_item {
  display: flex;
  &.batch_item {
    border-top: 1px solid #ebeef5;
    border-left: 1px solid #ebeef5;
    border-right: 1px solid #ebeef5;
    > .item_title {
      line-height: 90px;
    }
    > .item_right {
      line-height: 90px;
    }
  }
  > .item_title {
    width: 150px;
    font-size: 14px;
    text-align: right;
    line-height: 32px;
    color: #333;
    > em {
      color: red;
    }
  }
  > .item_right {
    flex: 1;
    line-height: 32px;
    > .item_tips {
      color: #999;
      font-size: 14px;
    }
    > .limit {
      padding-left: 25px;
    }
    .choose_list {
      > .choose_item {
        display: flex;
        line-height: 30px;
        > .item_left {
          width: 120px;
          background-color: #fff;
          color: #5a8bff;
          border: 1px solid #ddd;
          cursor: pointer;
          text-align: center;
          font-size: 14px;
        }
        > .item_right {
          flex: 1;
        }
      }
    }
  }
  .custom_share_item {
    display: flex;
    > .item_title {
      font-size: 14px;
      text-align: right;
      line-height: 32px;
    }
    > .item_right {
      flex: 1;
      line-height: 32px;
      .upload_img {
        padding-left: 25px;
        .bgImgDiv {
          width: 65px;
          height: 65px;
          border: 1px solid #ccc;
          background-position: center;
          cursor: pointer;
        }
      }
    }
  }
}
.shareContent a {
  text-decoration: none;
  color: #409eff;
}
.shareContent a:first-child {
  margin-right: 10px;
}
.imgContent {
  width: 80px;
  height: 80px;
  text-align: center;
  line-height: 65px;
  margin-left: 60px;
  border: 1px solid #ccc;
  cursor: pointer;
  box-sizing: border-box;
}
.imgContent .shareImg {
  width: 100%;
  height: 100%;
}
.picSizeTips {
  display: block;
  line-height: 80px;
  margin-left: 20px;
  color: rgb(153, 153, 153);
}
.noticeTip {
  color: #999;
}
.labelStyle {
  color: #5a8bff;
  cursor: pointer;
}
.labelContent {
  display: inline-block;
  height: 30px;
  background: rgba(235, 241, 255, 1);
  border: 1px solid rgba(180, 202, 255, 1);
  border-radius: 2px;
  text-align: center;
  line-height: 30px;
  padding: 0 10px;
  margin-right: 10px;
  color: #666;
}
.el-radio {
  margin-right: 0;
}
</style>
