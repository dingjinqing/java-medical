<template>
  <div>
    <wrapper class="dataContent">

      <!-- 日期筛选部分 -->
      <div style="display:flex">
        <div style="height:32px;line-height:32px">{{ $t('seckill.screen') }}：</div>
        <div class="selectTime">
          <el-date-picker
            size="small"
            v-model="starDate"
            type="datetime"
            :placeholder="$t('seckill.startTime')"
            value-format="yyyy-MM-dd HH:mm:ss"
          >
          </el-date-picker>
          <span>{{ $t('seckill.to') }}</span>
          <el-date-picker
            size="small"
            v-model="endDate"
            type="datetime"
            :placeholder="$t('seckill.endTime')"
            value-format="yyyy-MM-dd HH:mm:ss"
          >
          </el-date-picker>
        </div>
        <el-button
          style="margin-left: 10px;"
          type="primary"
          size="mini"
          @click="initEcharts"
        >{{ $t('seckill.screen') }}</el-button>
      </div>

      <!-- 表格数据部分 -->
      <section style="margin-top: 30px;">
        <div class="fromInfo topLine">
          <div style="display:flex">
            <div class="titless">{{ this.$t('seckill.payment') }}</div>
            <el-tooltip
              class="item"
              effect="light"
              :content="this.$t('seckill.paymentTip')"
              placement="top"
            >
              <i class="el-icon-warning-outline icons"></i>
            </el-tooltip>
          </div>
          <div
            class="num"
            style="color: #5A8BFF"
          >{{ total.totalPayment }}</div>
          <el-image
            class="left_image"
            :src="urls.url1"
          ></el-image>
        </div>
        <div class="fromInfo topLine">
          <div style="display:flex">
            <div class="titless">{{ this.$t('seckill.discount') }}</div>
            <el-tooltip
              class="item"
              effect="light"
              :content="this.$t('seckill.discountTip')"
              placement="top"
            >
              <i class="el-icon-warning-outline icons"></i>
            </el-tooltip>
          </div>
          <div
            class="num"
            style="color: #fc6181;"
          >{{ total.totalDiscount }}</div>
          <el-image
            class="left_image"
            :src="urls.url2"
          ></el-image>
        </div>
        <div class="fromInfo topLine">
          <div style="display:flex">
            <div class="titless">{{ this.$t('seckill.costEffect') }}</div>
            <el-tooltip
              class="item"
              effect="light"
              :content="this.$t('seckill.costEffectTip')"
              placement="top"
            >
              <i class="el-icon-warning-outline icons"></i>
            </el-tooltip>
          </div>
          <div
            class="num"
            style="color: #fdb64a;"
          >{{ total.totalCostEffectivenessRatio === 0 ? 0 : ((total.totalDiscount / total.totalPayment) * 100).toFixed(2) }}%</div>
          <el-image
            class="left_image"
            :src="urls.url3"
          ></el-image>
        </div>
        <div class="fromInfo topLine">
          <div style="display:flex">
            <div class="titless">{{ this.$t('reducePriceList.paidOrderNumber') }}</div>
            <el-tooltip
              class="item"
              effect="light"
              :content="this.$t('reducePriceList.paidOrderNumberTip')"
              placement="top"
            >
              <i class="el-icon-warning-outline icons"></i>
            </el-tooltip>
          </div>
          <div
            class="num"
            style="color: #3dcf9a;"
          >{{ total.totalPaidOrderNumber }}</div>
          <el-image
            class="left_image"
            :src="urls.url4"
          ></el-image>
        </div>
        <div class="fromInfo topLine">
          <div style="display:flex">
            <div class="titles">{{ this.$t('reducePriceList.paidGoodsNumber') }}</div>
            <el-tooltip
              class="item"
              effect="light"
              :content="this.$t('reducePriceList.paidGoodsNumberTip')"
              placement="top"
            >
              <i class="el-icon-warning-outline icons"></i>
            </el-tooltip>
          </div>
          <div
            class="num"
            style="color: #8379f7;"
          >{{ total.totalPaidGoodsNumber }}</div>
          <el-image
            class="left_image"
            :src="urls.url5"
          ></el-image>
        </div>
      </section>

      <section style="margin-bottom: 30px;">
        <div class="fromInfo">
          <div style="display:flex">
            <div class="titless">{{ this.$t('seckill.newUser') }}</div>
            <el-tooltip
              class="item"
              effect="light"
              :content="this.$t('seckill.newUser')"
              placement="top"
            >
              <i class="el-icon-warning-outline icons"></i>
            </el-tooltip>
          </div>
          <div
            class="num"
            style="color: #3dcf9a;"
          >{{ total.totalNewUserNumber }}</div>
          <el-image
            class="left_image"
            :src="urls.url6"
          ></el-image>
        </div>
        <div class="fromInfo">
          <div style="display:flex">
            <div class="titles">{{ this.$t('seckill.oldUser') }}</div>
            <el-tooltip
              class="item"
              effect="light"
              :content="this.$t('seckill.oldUserTip')"
              placement="top"
            >
              <i class="el-icon-warning-outline icons"></i>
            </el-tooltip>
          </div>
          <div
            class="num"
            style="color: #8379f7;"
          >{{ total.totalOldUserNumber }}</div>
          <el-image
            class="left_image"
            :src="urls.url7"
          ></el-image>
        </div>
      </section>

      <div id="charts"></div>

    </wrapper>
  </div>
</template>

<script>
import { getReduceAnalysisData } from '@/api/admin/marketManage/reducePrice.js'
import wrapper from '@/components/admin/wrapper/wrapper'
import echarts from 'echarts'

export default {
  components: { wrapper },
  data () {
    return {
      starDate: this.moment().startOf('month').format('YYYY-MM-DD HH:mm:ss'),
      endDate: this.moment().format('YYYY-MM-DD HH:mm:ss'),
      total: {}, // 表格
      echartInit: {
        colors: ['#5A8BFF', '#fc6181', '#fdb64a', '#3dcf9a', '#8379f7', '#5A8BFF', '#fc6181'],
        legendData: this.$t('reducePriceList.legendData')
      },
      echartData: {},
      option: {},
      myChart: {},
      urls: {
        url1: `${this.$imageHost}/image/admin/any_coner/any_coner_blue.png`,
        url2: `${this.$imageHost}/image/admin/any_coner/any_coner_pink.png`,
        url3: `${this.$imageHost}/image/admin/any_coner/any_coner_orange.png`,
        url4: `${this.$imageHost}/image/admin/any_coner/any_coner_yellow.png`,
        url5: `${this.$imageHost}/image/admin/any_coner/any_coner_aqua.png`,
        url6: `${this.$imageHost}/image/admin/any_coner/any_coner_green.png`,
        url7: `${this.$imageHost}/image/admin/any_coner/any_coner_purple.png`
      }
    }
  },
  watch: {
    lang () {
      this.updateEcharts()
    }
  },
  mounted () {
    // 初始化语言
    this.langDefault()
    this.initEcharts()
  },
  methods: {
    initEcharts () {
      this.myChart = echarts.init(document.getElementById('charts'))
      if (window.performance.navigation.type !== 1) {
        // 首次加载
        var startTime = new Date(this.$route.query.startTime).getTime()
        var endTime = new Date(this.$route.query.endTime).getTime()
        var nowTime = new Date(this.endDate).getTime()
        if (nowTime >= startTime && nowTime <= endTime) {
          // 进行中
          this.starDate = this.$route.query.startTime
          console.log(this.$route.query.startTime)
        }
        if (startTime > nowTime || endTime < nowTime) {
          // 未开始或已结束
          this.starDate = this.$route.query.startTime
          this.endDate = this.$route.query.endTime
          console.log(this.$route.query.startTime)
        }
      }

      let params = {
        id: this.$route.query.id,
        startTime: this.starDate,
        endTime: this.endDate
      }
      this.handleEcharts()
      getReduceAnalysisData(params).then((res) => {
        if (res.error === 0) {
          this.total = res.content.total
          this.echartData = res.content
          this.handleEcharts()
          this.myChart.hideLoading()
          this.myChart.dispatchAction({
            type: 'restore'
          })
        }
      })
    },
    handleEcharts () {
      this.option = {
        tooltip: {
          trigger: 'axis'
        },
        legend: {
          data: this.echartInit.legendData
        },
        grid: {
          left: '3%',
          right: '4%',
          bottom: '3%',
          containLabel: true
        },
        xAxis: [
          {
            type: 'category',
            data: this.echartData.dateList,
            boundaryGap: false
          }
        ],
        yAxis: [
          {
            name: this.$t('seckill.effactNum'),
            type: 'value'
          },
          {
            name: this.$t('seckill.costEffect'),
            type: 'value'
          }
        ],
        series: [
          {
            name: this.echartInit.legendData[0],
            type: 'line',
            color: this.echartInit.colors[0],
            yAxisIndex: 0,
            stack: '总量',
            data: this.echartData.paymentAmount
          },
          {
            name: this.echartInit.legendData[1],
            type: 'line',
            color: this.echartInit.colors[1],
            yAxisIndex: 0,
            stack: '总量',
            data: this.echartData.discountAmount
          },
          {
            name: this.echartInit.legendData[2],
            type: 'line',
            color: this.echartInit.colors[2],
            yAxisIndex: 0,
            stack: '总量',
            data: this.echartData.costEffectivenessRatio
          },
          {
            name: this.echartInit.legendData[3],
            type: 'line',
            color: this.echartInit.colors[3],
            yAxisIndex: 0,
            stack: '总量',
            data: this.echartData.paidOrderNumber
          },
          {
            name: this.echartInit.legendData[4],
            type: 'line',
            color: this.echartInit.colors[4],
            yAxisIndex: 0,
            stack: '总量',
            data: this.echartData.paidGoodsNumber
          },
          {
            name: this.echartInit.legendData[5],
            type: 'line',
            color: this.echartInit.colors[5],
            yAxisIndex: 0,
            stack: '总量',
            data: this.echartData.oldUserNumber
          },
          {
            name: this.echartInit.legendData[6],
            type: 'line',
            color: this.echartInit.colors[6],
            yAxisIndex: 0,
            stack: '总量',
            data: this.echartData.newUserNumber
          }
        ]
      }
      this.myChart.setOption(this.option)
      this.myChart.showLoading({
        text: 'loading',
        color: '#4cbbff',
        textColor: '#4cbbff'
        // maskColor: 'rgba(0, 0, 0, 0.9)'
      })
    },
    updateEcharts () {
      this.echartInit.legendData = this.$t('reducePriceList.legendData')
      this.initEcharts()
      this.myChart.setOption({
        legend: {
          data: this.$t('reducePriceList.legendData')
        },
        yAxis: [
          {
            name: this.$t('groupBuy.number'),
            type: 'value'
          },
          {
            name: this.$t('groupBuy.costBenefitRatio'),
            type: 'value'
          }
        ]
      })
    }
  }
}

</script>
<style lang="scss" scoped>
.dataContent {
  padding: 10px 50px;
  font-size: 14px;
  section {
    height: 130px;
    width: 100%;
    display: flex;
    flex-flow: row wrap;
    .topLine {
      border-top: 1px solid #eee;
    }
    .fromInfo:first-child {
      border-left: 1px solid #eee;
    }
    .fromInfo {
      flex: 0 1 19%;
      height: 130px;
      position: relative;
      border-right: 1px solid #eee;
      border-bottom: 1px solid #eee;
      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      .icons {
        margin-left: 10px;
        position: relative;
      }
      .num {
        margin-top: 15px;
        font-size: 30px;
      }
    }
  }
  #charts {
    width: 100%;
    height: 500px;
    left: -30px;
  }
  .left_image {
    position: absolute;
    bottom: 1px;
    left: 0;
    width: 44px;
    height: 40px;
  }
}
</style>
