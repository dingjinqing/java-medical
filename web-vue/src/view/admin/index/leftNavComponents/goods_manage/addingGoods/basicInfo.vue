<template>
  <div>
    <div class="title">基本信息</div>
    <div>
      <el-form ref="basicInfoForm" :model="goodsProductInfo" :rules="basicInfoRules" label-width="120px">
        <el-form-item label="商品名称：" prop="goodsName">
          <el-input ref="goodsNameInput" v-model="goodsProductInfo.goodsName" size="small" style="width:400px"/>
        </el-form-item>
        <el-form-item label="商品广告词：">
          <el-input v-model="goodsProductInfo.goodsAd" size="small" style="width:400px"/>
        </el-form-item>
        <el-form-item label="商品货号：">
          <el-input v-model="goodsProductInfo.goodsSn" size="small" style="width:170px;"/>
          <span class="inputTip">不填则由系统自动生成货号</span>
        </el-form-item>
        <el-form-item label="平台分类：" prop="catId">
          <el-select ref="catSelect" v-model="catIdTemp.firstCatId" size="small"
                     @change="catIdSelectChange(1,$event)" style="width:170px;">
            <el-option :value="null" label="请选择平台分类"/>
            <el-option v-for="item in catIdTemp.firstCatData" :label="item.catName" :value="item.catId"
                       :key="item.catId"/>
          </el-select>
          <el-select v-if="!!catIdTemp.firstCatId" v-model="catIdTemp.secondCatId" size="small"
                     @change="catIdSelectChange(2,$event)" style="width:170px;">
            <el-option :value="null" label="请选择平台分类"/>
            <el-option v-for="item in catIdTemp.secondCatData" :label="item.catName" :value="item.catId"
                       :key="item.catId"/>
          </el-select>
          <el-select v-if="!!catIdTemp.firstCatId&&!!catIdTemp.secondCatId" v-model="catIdTemp.thirdCatId"
                     size="small" @change="catIdSelectChange(3,$event)" style="width:170px;">
            <el-option :value="null" label="请选择平台分类"/>
            <el-option v-for="item in catIdTemp.thirdCatData" :label="item.catName" :value="item.catId"
                       :key="item.catId"/>
          </el-select>
          <span class="inputTip">
          “平台分类”是商品在系统中的属性，不会对用户展示。可在“基础配置”中设置默认平台分类。
          </span>
          <el-link type="primary" :underline="false" href="#" target="_blank">前往</el-link>
        </el-form-item>
        <el-form-item label="商品主图：" prop="goodsImgs">
          <div style="display: flex;align-items: center;flex-wrap: wrap;">
            <div v-for="(src,index) in goodsProductInfo.goodsImgs" :key="index" class="goodsImgWrap">
              <el-image fit="cover" :src="src" style="width: 78px; height: 78px;"></el-image>
              <span @click="deleteGoodsImg(index)" class="deleteIcon">×</span>
              <span @click="moveGoodsImgIndex(index,-1)"  class="moveIcon" style="left: 0px;">←</span>
              <span @click="moveGoodsImgIndex(index,1)" class="moveIcon" style="right: 0px;">→</span>
            </div>
            <div class="goodsImgWrap" @click="addGoodsImg" v-if="goodsProductInfo.goodsImgs.length < 5">
              <el-image fit="scale-down"  :src="imgHost+'/image/admin/add_img.png'" style="width: 78px; height: 78px;cursor: pointer;" />
            </div>
            <span class="inputTip">
            建议尺寸：800*800像素
            </span>
          </div>
        </el-form-item>
      </el-form>
      <!-- 基本信息更多配置 -->
      <el-collapse accordion>
        <el-collapse-item title="展开/收起更多配置" name="1">
          <el-form ref="basicInfoOtherForm" :model="goodsProductInfo" :rules="basicInfoRules" label-width="120px">
            <el-form-item label="单位：" prop="unit">
              <el-select ref="unitSelect" v-model="unitSelectedValue" @change="unitSelectChange" size="small" style="width:170px;">
                <el-option v-for="(item,index) in unitSelectOptions" :key="index" :value="item.value"
                           :label="item.label"/>
              </el-select>
              <el-input v-if="unitSelectedValue===null" v-model="unitCustomerValue" @change="unitCustomerChange"
                        size="small" style="width:100px;"/>
              <span v-if="unitSelectedValue===null" class="inputTip">长度限制为3个中文字符</span>
            </el-form-item>
            <el-form-item label="商家分类：" prop="sortId">
              <el-select filterable v-model="goodsProductInfo.sortId" placeholder="请选择商家分类" size="small" style="width:170px;">
                <el-option v-for="item in sortSelectOptions" :key="item.sortId" :label="item.sortName"
                           :value="item.sortId"
                           :style="{'marginLeft': item.level===1? '10px':'0px'}" />
              </el-select>
            </el-form-item>
            <el-form-item label="商品标签：" prop="goodsLabels">
              <el-select v-model="labelSelectedTempVal" placeholder="请选择商品标签" size="small" @change="labelSelectChange" style="width:170px;">
                <el-option v-for="item in labelSelectOptions" :key="item.id" :label="item.name" :value="item.id"/>
              </el-select>
              <el-link type="primary" :underline="false" @click="labelSelectRefresh" href="#" style="margin:0 5px;">刷新
              </el-link>
              |
              <el-link type="primary" :underline="false" href="#" style="margin:0 5px;">新建标签</el-link>
              |
              <el-link type="primary" :underline="false" href="#" style="margin:0 5px;">管理标签</el-link>
              <div v-if="labelSelectedItems.length>0" style="display: flex;flex-wrap: wrap;align-items:center;background-color: #f8f8f8;">
                <div>已选：</div>
                <div class="selectedWrap" v-for="(item,index) in labelSelectedItems" :key="index">
                  {{item.name}}
                  <span @click="deleteLabel(item,index)" class="deleteIcon">×</span>
                </div>
              </div>
            </el-form-item>
            <el-form-item label="商品品牌：" prop="brandName">
              <el-input v-model="goodsProductInfo.brandId" disabled placeholder="添加品牌" size="small"
                        @click="brandInputClick" style="width:170px;"/>
            </el-form-item>
            <el-form-item label="商品视频：" prop="video" @click="videoInputClick">

              <span class="inputTip">上传视频仅支持MP4格式。为保障无线端各种网络环境下正常播放，只支持上传大小不超过10M，时长不超过3分钟的视频。</span>
            </el-form-item>
          </el-form>
        </el-collapse-item>
      </el-collapse>
      <ImageDalog pageIndex='pictureSpace'  @handleSelectImg='imgDialogSelectedCallback'/>
    </div>
  </div>
</template>
<script>
// 接口函数引入
import {
  selectPlatformClassification,
  goodsSortAndGoodsBrandInitApi
} from '@/api/admin/goodsManage/addingGoods/addingGoods'

// js工具函数导入
import {isStrBlank} from "@/util/goodsUtil";
// 组件导入
import ImageDalog from '@/components/admin/imageDalog'
import addBrandDialog from './addBrandDialog'

export default {
  components: {ImageDalog, addBrandDialog},
  data () {
    return {
      goodsProductInfo: {
        // 基本信息
        goodsName: null,
        goodsAd: null,
        goodsSn: null,
        catId: null,
        goodsImgs: [],
        unit: '个',
        sortId: null,
        goodsLabels: null,
        brandId: null,
        goodsVideo: null,
        goodsVideoImg: null,
        goodsVideoSize: null,
        goodsVideoId: null
      },
      /* 基本信息部分 */
      // 基本信息验证
      basicInfoRules: {
        goodsName: [
          {required: true, message: '请输入商品名称', trigger: 'change'}
        ],
        catId: [
          {required: true, message: '请选择平台分类', trigger: 'change'}
        ],
        goodsImgs: [
          {required: true, message: '请选择商品图片', trigger: 'change'}
        ],
        unit: [
          {required: true, message: '单位不可为空', trigger: 'change'}
        ]
      },
      // 基本信平台分类辅助数据，对应分类每一级别的下落框数据和选中值
      catIdTemp: {
        firstCatId: null,
        secondCatId: null,
        thirdCatId: null,
        firstCatData: null,
        secondCatData: null,
        thirdCatData: null
      },
      imgHost: `${this.$imageHost}`,
      /* 基本信息更多配置部分 */
      unitSelectOptions: [{
        value: '个',
        label: '个'
      }, {
        value: '包',
        label: '包'
      }, {
        value: '箱',
        label: '箱'
      }, {
        value: '袋',
        label: '袋'
      }, {
        value: '套',
        label: '套'
      }, {
        value: '卷',
        label: '卷'
      }, {
        value: '件',
        label: '件'
      }, {
        value: '台',
        label: '台'
      },
      {
        value: '吨',
        label: '吨'
      }, {
        value: '平方米',
        label: '平方米'
      }, {
        value: '本',
        label: '本'
      }, {
        value: '幅',
        label: '幅'
      }, {
        value: '张',
        label: '张'
      }, {
        value: '支',
        label: '支'
      }, {
        value: '盒',
        label: '盒'
      }, {
        value: '份',
        label: '份'
      }, {
        value: '令',
        label: '令'
      }, {
        value: '千克',
        label: '千克'
      }, {
        value: null,
        label: '自定义'
      }],
      unitSelectedValue: '个',
      unitCustomerValue: null,
      // 商家分类下落框
      sortSelectOptions: null,
      // 商品品牌下拉框
      brandSelectOptions: null,
      /* 商品标签辅助数据 */
      // 商品标签下拉框
      labelSelectOptions: null,
      // 标签已选中列表
      labelSelectedItems: [],
      // 标签来下框选中瞬间的值
      labelSelectedTempVal: null
    }
  },
  methods: {
    /* 基本信息部分 */
    // 平台分类下拉框交互
    catIdSelectChange (level, catId) {
      this.goodsProductInfo.catId = catId

      //  选则一级则重置二三级
      if (level === 1) {
        this.catIdTemp.secondCatId = null
        this.catIdTemp.secondCatData = null
        this.catIdTemp.thirdCatId = null
        this.catIdTemp.thirdCatData = null
      }
      // 选择二级则重置三级
      if (level === 2) {
        this.catIdTemp.thirdCatId = null
        this.catIdTemp.thirdCatData = null
        if (catId === null) {
          this.goodsProductInfo.catId = this.catIdTemp.firstCatId
        }
      }
      // 选择三级
      if (level === 3 && catId === null) {
        this.goodsProductInfo.catId = this.catIdTemp.secondCatId
      }

      if (catId === null) {
        return
      }

      selectPlatformClassification(catId).then(res => {
        if (level === 1) {
          this.catIdTemp.secondCatData = res.content
        }
        if (level === 2) {
          this.catIdTemp.thirdCatData = res.content
        }
      })
    },
    /* 初始化平台分类一级下拉框数据 */
    catIdInit () {
      selectPlatformClassification(0).then(res => {
        this.catIdTemp.firstCatData = res.content
      })
    },
    /* 添加图片点击事件，弹出图片选择组件 */
    addGoodsImg () {
      this.$http.$emit('dtVisible')
    },
    /* 商品图片点击回调函数 */
    imgDialogSelectedCallback (src) {
      if (this.goodsProductInfo.goodsImgs.length >= 5) {
        return
      }
      this.goodsProductInfo.goodsImgs.push(src)
    },
    /* 删除商品图片 */
    deleteGoodsImg (index) {
      this.goodsProductInfo.goodsImgs.splice(index, 1)
    },
    /* 移动商品图片 -1:左移 1:右移 */
    moveGoodsImgIndex (index, direction) {
      let tempArr = this.goodsProductInfo.goodsImgs.splice(index, 1)
      let arrLength = this.goodsProductInfo.goodsImgs.length
      let targetIndex = index + direction

      index = targetIndex < 0 ? arrLength : targetIndex > arrLength ? 0 : targetIndex

      this.goodsProductInfo.goodsImgs.splice(index, 0, tempArr[0])
    },
    /* 基本信息更多配置部分 */
    // 单位选择下拉框处理事件
    unitSelectChange (value) {
      if (value === null) {
        // 当用户自定义过单位然后选择其他单位，当再次选择自定义时可以保留上一次的输入
        this.goodsProductInfo.unit = this.unitCustomerValue
      } else {
        this.goodsProductInfo.unit = value
      }
      this.$refs.basicInfoOtherForm.validateField('unit')
    },
    // 自定义单位处理事件
    unitCustomerChange () {
      // 自定义单位长度超过3字符，则返回
      if (!isStrBlank(this.unitCustomerValue) && this.unitCustomerValue.length > 3) {
        this.unitCustomerValue = this.unitCustomerValue.substring(0, 3)
        this.goodsProductInfo.unit = this.unitCustomerValue
        this.$refs.basicInfoOtherForm.validateField('unit')
        return
      }
      this.goodsProductInfo.unit = this.unitCustomerValue
      this.$refs.basicInfoOtherForm.validateField('unit')
    },
    // 初始化商家分类和商品标签
    sortAndLabelAndBrandSelectInit () {
      goodsSortAndGoodsBrandInitApi().then(res => {
        const {content: {goodsBrands, goodsLabels, goodsSorts}} = res
        this.sortSelectOptions = goodsSorts
        this.labelSelectOptions = goodsLabels
        this.brandSelectOptions = goodsBrands
      })
    },
    /* 标签下拉框选择事件 */
    labelSelectChange () {
      this.labelSelectOptions = this.labelSelectOptions.filter(item => {
        if (item.id === this.labelSelectedTempVal) {
          this.labelSelectedItems.push(item)
          return false
        }
        return true
      })
      this.labelSelectedTempVal = null
    },
    /* 刷新标签下拉列表，要将已选的项剔除 */
    labelSelectRefresh () {
      goodsSortAndGoodsBrandInitApi().then(res => {
        const {content: {goodsLabels}} = res
        this.labelSelectOptions = goodsLabels.filter(item => !this.labelSelectedItems.some(innerItem => innerItem.id === item.id))
      })
    },
    /* 删除商品已选标签,并将删除的项添加到下拉框内 */
    deleteLabel (item, index) {
      this.labelSelectedItems.splice(index, 1)
      this.labelSelectOptions.push(item)
    },
    brandInputClick () {
      // TODO: 目前的实现的商品品牌选择框逻辑错误，需要修改
    },
    videoInputClick () {
      // TODO: 视频选择弹出未实现
    },
    /** 此函数由父组件主动调用 **/
    /* 验证数据是否全部合法 */
    validateFormData () {
      if (isStrBlank(this.goodsProductInfo.goodsName)) {
        this.$message('请输入商品名称')
        this.$refs.goodsNameInput.focus()
        return false
      }

      if (this.goodsProductInfo.catId === null) {
        this.$message('请选择平台分类')
        this.$refs.catSelect.focus()
        return false
      }

      if (this.goodsProductInfo.goodsImgs.length === 0) {
        this.$message('请选择商品图片')
        return false
      }

      if (this.goodsProductInfo.unit === null) {
        this.$message('请选择商品单位')
        this.$refs.unitSelect.focus()
        return false
      }

      return true
    },
    /* 获取传给后台的表单数据 */
    getFormData () {
      let retData = {
        ...this.goodsProductInfo,
        goodsImg: null
      }

      retData.goodsLabels = []
      this.labelSelectedItems.forEach(item => retData.goodsLabels.push(item.id))

      // 处理商品图片
      // 只有一个商品主图
      if (this.goodsProductInfo.goodsImgs.length === 1) {
        retData.goodsImg = this.goodsProductInfo.goodsImgs[0]
        retData.goodsImgs = null
      } else if (this.goodsProductInfo.goodsImgs.length > 1) {
        // 有商品主图和幅图
        // 避免和goodsProductInfo共享同一个数组
        retData.goodsImgs = []
        retData.goodsImg = this.goodsProductInfo.goodsImgs[0]
        for (let i = 1; i < this.goodsProductInfo.goodsImgs.length; i++) {
          retData.goodsImgs.push(this.goodsProductInfo.goodsImgs[i])
        }
      } else {
        // 没有数据直接设置为null,这样后台不会执行对应的空sql
        retData.goodsImgs = null
      }

      return retData
    },
  },
  mounted () {
    // 初始化平台分类一级下拉框
    this.catIdInit()
    // 初始化商家分类和商品标签
    this.sortAndLabelAndBrandSelectInit()
  }
}
</script>
<style scoped>
  .inputTip {
    color: #999;
    margin-left: 15px;
  }
  .title {
    font-weight: bold;
    height: 40px;
    background: #f8f8f8;
    line-height: 40px;
    width: 100%;
    padding-left: 10px;
    margin: 20px 0;
  }
  .goodsImgWrap{
    width: 80px;
    height: 80px;
    border: 1px solid #ccc;
    margin: 5px 5px;
    position: relative;
  }
  .goodsImgWrap .deleteIcon {
    width: 17px;
    height: 17px;
    color: #fff;
    background: #ccc;
    border: 1px solid #ccc;
    border-radius: 50%;
    line-height: 17px;
    text-align: center;
    position: absolute;
    top: -8px;
    right: -8px;
    cursor: pointer;
    opacity: 0.8;
  }
  .goodsImgWrap .moveIcon{
    width: 17px;
    height: 17px;
    display: none;
    color: #fff;
    background: #ccc;
    border: 1px solid #ccc;
    line-height: 17px;
    text-align: center;
    position: absolute;
    bottom: 0px;
    cursor: pointer;
    opacity: 0.8;
  }
  .goodsImgWrap:hover .moveIcon{
    display: block;
  }
  .selectedWrap{
    min-width: 70px;
    height: 22px;
    border: 1px solid #ccc;
    line-height: 22px;
    text-align: center;
    padding: 0px 5px;
    margin:0px 5px;
    background-color: #fff;
    position: relative;
  }
  .selectedWrap .deleteIcon {
    width: 17px;
    height: 17px;
    color: #fff;
    background: #ccc;
    border: 1px solid #ccc;
    border-radius: 50%;
    line-height: 17px;
    text-align: center;
    position: absolute;
    top: -8px;
    right: -8px;
    cursor: pointer;
    opacity: 0.8;
  }
</style>
